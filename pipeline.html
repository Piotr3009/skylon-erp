<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <title>Joinery Core - Operational System - Pipeline Manager</title>
    <link rel="stylesheet" href="css/styles.css?v=12">
   
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
    <script src="js/config.js"></script>
    <script src="js/toast.js"></script>

    <script src="js/menu.js"></script>
    <script src="js/permissions.js"></script>
</head>
<body class="pipeline-theme">
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="app-title">Joinery Core - Operational System - Pipeline Manager</div>
            <div class="navigation-links">
                <!-- Menu loaded by menu.js -->
            </div>
        </div>

        <!-- Toolbar -->
        <div class="toolbar" style="display: flex; align-items: center;">
            <div style="display: flex; gap: 10px;">
                <button class="toolbar-btn primary" onclick="addPipelineProject()">+ Add Pipeline Project</button>
                <button class="toolbar-btn success" onclick="openPipelineFinishedModal()">‚úÖ Pipeline Finished</button>
                <button class="toolbar-btn" onclick="openPhaseManager()">‚öôÔ∏è Manage Phases</button>
            </div>
            
            <!-- Sort buttons -->
            <div style="display: flex; gap: 10px; margin-left: 20px;">
                <button class="toolbar-btn sort-btn" data-sort="number" onclick="setPipelineSortMode('number')" title="Sort by project number">
                    üî¢ By Number
                </button>
                <button class="toolbar-btn sort-btn active" data-sort="leadtime" onclick="setPipelineSortMode('leadtime')" title="Sort by lead time">
                    ‚è±Ô∏è By Lead Time
                </button>
            </div>
            
            <div style="position: absolute; left: 50%; transform: translateX(-50%); display: flex; gap: 10px;">
                <button class="toolbar-btn" onclick="shiftWeek(-1)">‚Üê Week</button>
                <button class="toolbar-btn" onclick="shiftWeek(1)">Week ‚Üí</button>
            </div>
            
            <div class="export-dropdown" style="margin-left: auto;">
                <button class="toolbar-btn">Export ‚ñº</button>
                <div class="export-menu">
                    <button onclick="exportPipelineJSON()">Export JSON</button>
                    <button onclick="exportPipelineCSV()">Export CSV</button>
                    <button onclick="importPipelineJSON()">Import JSON</button>
                </div>
            </div>
        </div>

        <!-- Chart -->
        <div class="chart-wrapper">
            <div class="chart-header">
                <div class="project-header">
                    <div class="header-column header-number">No.</div>
                    <div class="header-column-divider"></div>
                    <div class="header-column header-type">Type</div>
                    <div class="header-column-divider"></div>
                    <div class="header-column header-name">Project</div>
                    <div class="header-column-divider"></div>
                    <div class="header-column header-date-added">Date Added</div>
                    <div class="header-column-divider"></div>
                    <div class="header-column header-lead-time">Lead Time</div>
                    <div class="header-column-divider"></div>
                    <div class="header-column header-actions">Actions</div>
                </div>
                <div class="timeline-header" id="timelineHeader">
                    <!-- Timeline will be generated here -->
                </div>
            </div>
            <div class="chart-body" id="chartBody">
                <!-- Projects will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Add/Edit Pipeline Project Modal -->
    <div class="modal" id="projectModal">
        <div class="modal-content">
            <div class="modal-header" id="projectModalTitle">Add Pipeline Project</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Pipeline Number</label>
                    <input type="text" id="projectNumber" placeholder="e.g. PL001/2025">
                </div>
                
                <div class="form-group">
                    <label>Project Type</label>
                    <div class="type-selector">
                        <div class="type-option" data-type="sash" onclick="selectProjectType('sash')">
                            <div class="type-icon" style="color: #3b82f6;">
                                <svg viewBox="0 0 64 64" width="32" height="32" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <g stroke="currentColor" stroke-width="2.5"><rect x="14" y="6" width="36" height="48" rx="2" stroke-width="2"/><rect x="18" y="8" width="28" height="42" rx="2"/><line x1="18" y1="29" x2="46" y2="29"/><rect x="14" y="50" width="36" height="4" rx="1" stroke-width="2"/></g>
                                </svg>
                            </div>
                            <div class="type-name">Sash Window</div>
                        </div>
                        <div class="type-option" data-type="casement" onclick="selectProjectType('casement')">
                            <div class="type-icon" style="color: #06b6d4;">
                                <svg viewBox="0 0 64 64" width="32" height="32" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <g stroke="currentColor" stroke-width="2.5"><rect x="8" y="8" width="48" height="48" rx="4"/><line x1="32" y1="8" x2="32" y2="56"/><rect x="12" y="12" width="16" height="40" rx="1" stroke-width="1" opacity="0.5"/><rect x="36" y="12" width="16" height="40" rx="1" stroke-width="1" opacity="0.5"/><circle cx="24" cy="32" r="3" stroke-width="2"/><line x1="24" y1="32" x2="16" y2="32" stroke-width="2"/><path d="M 56 20 Q 60 32 56 44" stroke-width="1.5" stroke-dasharray="3 2" opacity="0.6"/><rect x="4" y="56" width="56" height="4" rx="1" stroke-width="2"/></g>
                                </svg>
                            </div>
                            <div class="type-name">Casement</div>
                        </div>
                        <div class="type-option" data-type="kitchen" onclick="selectProjectType('kitchen')">
                            <div class="type-icon" style="color: #f97316;">
                                <svg viewBox="0 0 64 64" width="32" height="32" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <g stroke="currentColor" stroke-width="2"><ellipse cx="32" cy="16" rx="14" ry="5" stroke-width="2.5"/><line x1="46" y1="16" x2="52" y2="12"/><line x1="12" y1="24" x2="52" y2="24" stroke-width="3"/><rect x="12" y="28" width="18" height="26" rx="2" stroke-width="2.5"/><rect x="15" y="32" width="12" height="18" rx="1" stroke-width="1.5" opacity="0.6"/><circle cx="26" cy="41" r="1.5" stroke-width="1.5"/><rect x="34" y="28" width="18" height="26" rx="2" stroke-width="2.5"/><line x1="34" y1="36" x2="52" y2="36" stroke-width="1.5"/><line x1="34" y1="43" x2="52" y2="43" stroke-width="1.5"/><circle cx="46" cy="32" r="1" stroke-width="1.5"/><circle cx="46" cy="39.5" r="1" stroke-width="1.5"/><circle cx="46" cy="48" r="1" stroke-width="1.5"/></g>
                                </svg>
                            </div>
                            <div class="type-name">Kitchen</div>
                        </div>
                        <div class="type-option" data-type="wardrobe" onclick="selectProjectType('wardrobe')">
                            <div class="type-icon" style="color: #8b5cf6;">
                                <svg viewBox="0 0 64 64" width="32" height="32" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <g stroke="currentColor" stroke-width="2.5"><rect x="8" y="6" width="48" height="52" rx="3"/><line x1="32" y1="6" x2="32" y2="58"/><rect x="24" y="28" width="3" height="8" rx="1.5" stroke-width="1.5"/><rect x="37" y="28" width="3" height="8" rx="1.5" stroke-width="1.5"/></g>
                                </svg>
                            </div>
                            <div class="type-name">Wardrobe</div>
                        </div>
                        <div class="type-option" data-type="partition" onclick="selectProjectType('partition')">
                            <div class="type-icon" style="color: #8b4513;">
                                <svg viewBox="0 0 64 64" width="32" height="32" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <g stroke="currentColor" stroke-width="2"><rect x="8" y="10" width="48" height="44" rx="2" stroke-width="2.5"/><line x1="22" y1="10" x2="22" y2="54" stroke-width="2.5"/><line x1="42" y1="10" x2="42" y2="54" stroke-width="2.5"/><rect x="10" y="20" width="10" height="28" rx="1"/><circle cx="18" cy="34" r="1.5" stroke-width="1.5"/><rect x="24" y="14" width="16" height="36" rx="1" stroke-width="1" opacity="0.4"/><rect x="44" y="14" width="10" height="36" rx="1" stroke-width="1" opacity="0.4"/></g>
                                </svg>
                            </div>
                            <div class="type-name">Partition Wall</div>
                        </div>
                        <div class="type-option" data-type="externalSpray" onclick="selectProjectType('externalSpray')">
                            <div class="type-icon" style="color: #8b5cf6;">
                                <svg viewBox="0 0 64 64" width="32" height="32" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <g stroke="currentColor" stroke-width="2"><ellipse cx="24" cy="18" rx="6" ry="4"/><line x1="24" y1="14" x2="24" y2="24"/><rect x="20" y="24" width="12" height="6" rx="1" stroke-width="2.5"/><line x1="32" y1="27" x2="38" y2="27" stroke-width="3"/><path d="M 24 30 L 24 38 L 20 42 L 20 38 Z" stroke-width="2.5"/><path d="M 26 30 L 26 34 L 24 36"/><line x1="40" y1="20" x2="44" y2="18" opacity="0.7"/><line x1="42" y1="24" x2="48" y2="22" opacity="0.7"/><line x1="40" y1="28" x2="46" y2="28" opacity="0.7"/><line x1="42" y1="32" x2="48" y2="34" opacity="0.7"/></g>
                                </svg>
                            </div>
                            <div class="type-name">External Spray</div>
                        </div>
                        <div class="type-option" data-type="internalDoors" onclick="selectProjectType('internalDoors')">
                            <div class="type-icon" style="color: #10b981;">
                                <svg viewBox="0 0 64 64" width="32" height="32" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <g stroke="currentColor" stroke-width="2.5"><path d="M 16 6 L 48 6 L 48 58 L 16 58 Z"/><path d="M 48 6 L 56 14 L 56 50 L 48 58" fill="none"/><rect x="20" y="10" width="24" height="10" rx="1.5" stroke-width="1.5" opacity="0.6"/><rect x="20" y="23" width="24" height="10" rx="1.5" stroke-width="1.5" opacity="0.6"/><rect x="20" y="36" width="24" height="10" rx="1.5" stroke-width="1.5" opacity="0.6"/><rect x="20" y="49" width="24" height="7" rx="1.5" stroke-width="1.5" opacity="0.6"/><circle cx="42" cy="32" r="2.5" stroke-width="2"/></g>
                                </svg>
                            </div>
                            <div class="type-name">Internal Doors</div>
                        </div>
                        <div class="type-option selected" data-type="other" onclick="selectProjectType('other')">
                            <div class="type-icon" style="color: #6b7280;">
                                <svg viewBox="0 0 64 64" width="32" height="32" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <g stroke="currentColor" stroke-width="2"><path d="M 12 32 L 32 12 L 52 32" stroke-width="2.5" fill="none"/><line x1="32" y1="12" x2="32" y2="18" stroke-width="1.5" opacity="0.6"/><rect x="18" y="32" width="28" height="24" rx="3" stroke-width="2.5"/><rect x="28" y="40" width="8" height="16" rx="2"/><circle cx="34" cy="48" r="1" stroke-width="1.5"/><rect x="20" y="36" width="6" height="6" rx="1" stroke-width="1.5" opacity="0.6"/><line x1="23" y1="36" x2="23" y2="42" stroke-width="1" opacity="0.5"/></g>
                                </svg>
                            </div>
                            <div class="type-name">Other</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Project Name</label>
                    <input type="text" id="projectName" placeholder="e.g. 4x Sash Windows">
                </div>
                
                <div class="form-group">
                    <label>Site Address <span style="color: #888; font-size: 11px;">(for installation/measurements)</span></label>
                    <textarea id="projectSiteAddress" placeholder="e.g. 123 High Street, London, SW1A 1AA" style="width: 100%; padding: 8px; background: #3e3e42; border: 1px solid #555; color: #e8e2d5; border-radius: 3px; min-height: 60px;"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Project Contact <span style="color: #888; font-size: 11px;">(override client default)</span></label>
                    <input type="text" id="projectContact" placeholder="Leave blank to use client's default contact" style="width: 100%; padding: 8px; background: #3e3e42; border: 1px solid #555; color: #e8e2d5; border-radius: 3px;">
                </div>
                
               <div class="form-group">
    <label>Klient (wymagany)</label>
    <select id="projectClient" style="width: 100%; padding: 8px; background: #3e3e42; border: 1px solid #555; color: #e8e2d5; border-radius: 3px;">
        <option value="">-- Wybierz klienta z bazy --</option>
    </select>
    <button type="button" onclick="window.open('clients.html', '_blank')" style="margin-top: 5px; padding: 5px 10px; background: #007acc; border: none; color: white; border-radius: 3px; cursor: pointer;">
        + Dodaj nowego klienta
    </button>
</div>
                
                <div class="form-group">
                    <label>Estimated Value (¬£)</label>
                    <input type="number" id="pipelineEstimatedValue" step="0.01" min="0" placeholder="e.g. 15000">
                </div>
                
                <div class="form-group">
                    <label>Start Date <span style="color: #888; font-size: 11px;">(Leave blank for today)</span></label>
                    <input type="date" id="projectStartDate" placeholder="Auto: Today">
                    <div style="font-size: 10px; color: #999; margin-top: 4px;">
                        ‚ÑπÔ∏è Set a different date if the pipeline process should start on a specific day. Otherwise, today's date will be used automatically.
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Select Pipeline Phases (uncheck unwanted phases)</label>
                    <div class="phase-list" id="phasesList">
                        <!-- Phase checkboxes will be added here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn" onclick="closeModal('projectModal')">Cancel</button>
                <button class="modal-btn primary" onclick="savePipelineProject()">Save</button>
            </div>
        </div>
    </div>

    <!-- Pipeline Finished Modal -->
    <div class="modal" id="pipelineFinishedModal">
        <div class="modal-content">
            <div class="modal-header">Pipeline Project - Final Decision</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Select Pipeline Project</label>
                    <select id="pipelineProjectSelect" style="width: 100%; padding: 8px;">
                        <option value="">Select project...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label style="font-weight: bold; color: #4ade80;">What happened with this pipeline project?</label>
                    <div style="display: grid; gap: 10px; margin-top: 10px;">
                        
                        <!-- WON - Convert to Production -->
                        <div style="border: 2px solid #4ade80; padding: 15px; border-radius: 5px; background: #1a2f1a;">
                            <div style="font-weight: bold; color: #4ade80; margin-bottom: 10px;">
                                ‚úÖ WON - Convert to Production
                            </div>
                            <div style="font-size: 12px; color: #999; margin-bottom: 10px;">
                                Client accepted the quote. Move to production schedule.
                            </div>
                            <label style="display: block; margin-bottom: 5px;">Production Deadline (from contract)</label>
                            <input type="date" id="productionDeadline" style="width: 100%; padding: 8px; background: #3e3e42; border: 1px solid #555; color: #e8e2d5; border-radius: 3px; margin-bottom: 10px;">
                            <button class="status-btn success" onclick="convertToProduction()" style="width: 100%;">
                                ‚úÖ Convert to Production
                            </button>
                        </div>
                        
                        <!-- LOST - Canceled -->
                        <div style="border: 2px solid #f59e0b; padding: 15px; border-radius: 5px; background: #2a1f0a;">
                            <div style="font-weight: bold; color: #f59e0b; margin-bottom: 10px;">
                                ‚è∏Ô∏è LOST - Client Canceled
                            </div>
                            <div style="font-size: 12px; color: #999; margin-bottom: 10px;">
                                Client decided not to proceed with the project.
                            </div>
                            <label style="display: block; margin-bottom: 5px;">Reason (optional)</label>
                            <textarea id="cancelledReason" placeholder="e.g. Budget constraints, chose another supplier..." style="width: 100%; padding: 8px; background: #3e3e42; border: 1px solid #555; color: #e8e2d5; border-radius: 3px; margin-bottom: 10px; min-height: 60px;"></textarea>
                            <button class="status-btn warning" onclick="archiveAsCanceled()" style="width: 100%; background: #f59e0b;">
                                ‚è∏Ô∏è Archive as Canceled
                            </button>
                        </div>
                        
                        <!-- LOST - Failed -->
                        <div style="border: 2px solid #ef4444; padding: 15px; border-radius: 5px; background: #2a0a0a;">
                            <div style="font-weight: bold; color: #ef4444; margin-bottom: 10px;">
                                ‚ùå LOST - Project Failed
                            </div>
                            <div style="font-size: 12px; color: #999; margin-bottom: 10px;">
                                Project couldn't be completed (technical issues, disputes, etc.)
                            </div>
                            <label style="display: block; margin-bottom: 5px;">Reason (optional)</label>
                            <textarea id="failedReason" placeholder="e.g. Technical issues, client disputes..." style="width: 100%; padding: 8px; background: #3e3e42; border: 1px solid #555; color: #e8e2d5; border-radius: 3px; margin-bottom: 10px; min-height: 60px;"></textarea>
                            <button class="status-btn danger" onclick="archiveAsFailed()" style="width: 100%;">
                                ‚ùå Archive as Failed
                            </button>
                        </div>
                        
                        
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn" onclick="closeModal('pipelineFinishedModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Other modals (copy from index.html) -->
    <!-- Phase Edit Modal -->
    <div class="modal" id="phaseEditModal">
        <div class="modal-content">
            <div class="modal-header" id="phaseEditTitle">Edit Phase</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Phase Status</label>
                    <select id="phaseStatus">
                        <option value="notStarted">‚è∏Ô∏è Not Started</option>
                        <option value="inProgress">‚ñ∂Ô∏è In Progress</option>
                        <option value="completed">‚úÖ Completed</option>
                        <option value="problem">‚ö†Ô∏è Problem/Delayed</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Duration (work days, excluding Sundays)</label>
                    <input type="number" id="phaseDuration" min="1" value="3">
                </div>
                
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="phaseNotes" placeholder="Add any notes about this phase..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn danger" id="deletePhaseBtn" onclick="deleteCurrentPhase()" style="margin-right: auto;">Delete Phase</button>
                <button class="modal-btn" onclick="closeModal('phaseEditModal')">Cancel</button>
                <button class="modal-btn primary" onclick="savePhaseChanges()">Save</button>
            </div>
        </div>
    </div>

    <!-- Days Off Modal -->

    <!-- Phase Manager Modal -->
    <div class="modal" id="phaseModal">
        <div class="modal-content">
            <div class="modal-header">Manage Phases</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Add Custom Phase</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="newPhaseName" placeholder="Phase name">
                        <input type="color" id="newPhaseColor" value="#4a90e2">
                        <button class="modal-btn primary" onclick="addCustomPhase()">Add</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Available Phases</label>
                    <div id="availablePhases" style="max-height: 300px; overflow-y: auto;">
                        <!-- Phases list will be shown here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn primary" onclick="closeModal('phaseModal')">Done</button>
            </div>
        </div>
    </div>

  

    <!-- Hidden file input -->
    <input type="file" id="fileInput" accept=".json" style="display: none;">

    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Scripts in correct order - PIPELINE u≈ºywa drag-pipeline.js -->
    <script src="js/utils.js?v=2"></script>
    <script src="js/calendar.js?v=2"></script>
    <script src="js/project-icons.js?v=1"></script>
    <script src="js/data.js?v=2"></script>
    <script src="js/team.js?v=2"></script>
    <script src="js/pipeline-projects.js?v=2"></script>
    <script src="js/phases.js?v=2"></script>
    <script src="js/drag-pipeline.js?v=2"></script>
    <script src="js/pipeline-gantt.js?v=3"></script>
    <script src="js/modals.js?v=2"></script>
    <script src="js/project-files.js?v=2"></script>
    <script src="js/google-drive-picker.js?v=2"></script>
    <script src="js/sticky-fix.js?v=2"></script>
    <script src="js/pipeline-app.js?v=2"></script>
</body>
</html>