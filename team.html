<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <title>Joinery Core - Operational System - Team Management</title>
    <link rel="stylesheet" href="css/styles.css?v=10">
    
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
    <script src="js/config.js"></script>
    <script src="js/toast.js"></script>
    
    <style>
        /* Team specific styles */
        .team-container {
            padding: 20px;
            overflow-y: auto;
            height: calc(100vh - 120px);
        }
        
        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #2d2d30;
            border-radius: 5px;
        }
        
        .search-bar input {
            flex: 1;
            padding: 10px;
            background: #3e3e42;
            border: 1px solid #555;
            color: #e8e2d5;
            border-radius: 3px;
        }
        
        .team-table {
            width: 100%;
            border-collapse: collapse;
            background: #2d2d30;
        }
        
        .team-table th {
            background: #252526;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #FFA500;
        }
        
        .team-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #3e3e42;
        }
        
        .team-table tr:hover {
            background: #3e3e42;
        }
        
        .department-badge {
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .dept-admin { background: #4a90e2; }
        .dept-production { background: #547d56; }
        .dept-spray { background: #e99f62; }
        .dept-installation { background: #7a5195; }
        .dept-drivers { background: #d35400; }
        .dept-management { background: #c0392b; }
       
        
        .status-badge {
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .status-active { background: #4caf50; }
        .status-probation { background: #ff9800; }
        .status-holiday { background: #2196f3; }
        .status-sick { background: #f44336; }
        .status-inactive { background: #666; }
        
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: #2d2d30;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #FFA500;
        }
        
        .stat-label {
            font-size: 12px;
            color: #9e9e9e;
            margin-top: 5px;
        }
        
        .color-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin-right: 8px;
            vertical-align: middle;
            border: 1px solid #555;
        }
        
        .holiday-bar {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .holiday-progress {
            width: 60px;
            height: 8px;
            background: #3e3e42;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .holiday-fill {
            height: 100%;
            background: #4caf50;
        }
        
        /* Detail panel styles */
        .detail-panel {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: #2d2d30;
            border-left: 1px solid #555;
            transition: right 0.3s;
            z-index: 100;
            overflow-y: auto;
        }
        
        .detail-panel.active {
            right: 0;
        }
        
        .detail-header {
            padding: 20px;
            background: #252526;
            border-bottom: 2px solid #FFA500;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .detail-body {
            padding: 20px;
        }
        
        .detail-section {
            margin-bottom: 30px;
        }
        
        .detail-section h3 {
            color: #FFA500;
            margin-bottom: 15px;
            font-size: 14px;
            text-transform: uppercase;
        }

        /* Tabs styling */
        .team-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            border-bottom: 2px solid #3e3e42;
        }
        
        .team-tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #999;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }
        
        .team-tab:hover {
            color: #e8e2d5;
        }
        
        .team-tab.active {
            color: #FFA500;
            border-bottom-color: #FFA500;
        }
        
        .team-tab .tab-count {
            background: #3e3e42;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-left: 8px;
        }
        
        .team-tab.active .tab-count {
            background: #FFA500;
            color: #1e1e1e;
        }

        /* Archived section */
        .archived-section {
            display: none;
        }
        
        .archived-section.active {
            display: block;
        }
        
        .active-section {
            display: block;
        }
        
        .active-section.hidden {
            display: none;
        }

        /* Archived employee card */
        .archived-card {
            background: #2d2d30;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #666;
        }
        
        .archived-card.reason-resigned { border-left-color: #3498db; }
        .archived-card.reason-fired { border-left-color: #e74c3c; }
        .archived-card.reason-contract_ended { border-left-color: #f39c12; }
        .archived-card.reason-other { border-left-color: #9b59b6; }
        
        .archived-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .archived-name {
            font-size: 18px;
            font-weight: 600;
            color: #e8e2d5;
        }
        
        .archived-meta {
            color: #999;
            font-size: 13px;
            margin-top: 4px;
        }
        
        .archived-reason-badge {
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .reason-resigned { background: #3498db; color: #fff; }
        .reason-fired { background: #e74c3c; color: #fff; }
        .reason-contract_ended { background: #f39c12; color: #1e1e1e; }
        .reason-other { background: #9b59b6; color: #fff; }
        
        .archived-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .archived-detail-item {
            background: #252526;
            padding: 10px;
            border-radius: 4px;
        }
        
        .archived-detail-label {
            font-size: 11px;
            color: #999;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        
        .archived-detail-value {
            color: #e8e2d5;
            font-size: 14px;
        }
        
        .holidays-history {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #3e3e42;
        }
        
        .holidays-history h4 {
            color: #FFA500;
            font-size: 13px;
            margin-bottom: 10px;
        }
        
        .holiday-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            background: #252526;
            border-radius: 4px;
            margin-bottom: 5px;
            font-size: 13px;
        }
        
        .holiday-type {
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
        }
        
        .holiday-type.annual { background: #27ae60; }
        .holiday-type.sick { background: #e74c3c; }
        .holiday-type.unpaid { background: #95a5a6; }
    </style>
    <script src="js/menu.js"></script>
    <script src="js/permissions.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="app-title">Joinery Core - Operational System - Team Management</div>
            <div class="navigation-links">
                <!-- Menu loaded by menu.js -->
            </div>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <button class="toolbar-btn primary" onclick="openAddEmployeeModal()">+ Add Employee</button>
            <button class="toolbar-btn" onclick="openWagesModal()">üí∞ Wages</button>
            <button class="toolbar-btn" onclick="window.location.href='holidays.html'">üèñÔ∏è Holidays</button>
            <div class="export-dropdown">
                <button class="toolbar-btn">Export ‚ñº</button>
                <div class="export-menu">
                    <button onclick="exportTeamCSV()">Export CSV</button>
                    <button onclick="exportTeamJSON()">Export JSON</button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="team-container">

            <!-- Tabs -->
            <div class="team-tabs">
                <button class="team-tab active" onclick="showActiveTeam()" id="activeTab">
                    üë• Active Employees <span class="tab-count" id="activeCount">0</span>
                </button>
                <button class="team-tab" onclick="showArchivedTeam()" id="archivedTab">
                    üì¶ Archived <span class="tab-count" id="archivedCount">0</span>
                </button>
            </div>

            <!-- Active Section -->
            <div class="active-section" id="activeSection">
            <!-- Search Bar -->
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="üîç Search by name, email, role..." onkeyup="searchTeam()">
                
<select id="filterDepartment" onchange="filterTeam()">
    <option value="">All Departments</option>
    <option value="production">Production</option>
    <option value="spray">Spray</option>
    <option value="installation">Installation</option>
    <option value="drivers">Drivers</option>
    <option value="management">Management</option>
    <option value="admin">Admin</option>



                   
                </select>
                <select id="filterStatus" onchange="filterTeam()">
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="probation">Probation</option>
                    <option value="holiday">Holiday</option>
                    <option value="inactive">Inactive</option>
                </select>
                
            </div>

            <!-- System Accounts Section (Only for Admin) -->
            <div id="systemAccountsSection" style="margin-bottom: 30px; display: none;">
                <h3 style="color: #fff; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <span>üîê System Accounts</span>
                    <span style="font-size: 12px; color: #999; font-weight: normal;">(User accounts without employee profiles)</span>
                </h3>
                <table class="team-table">
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Full Name</th>
                            <th>Account Role</th>
                            <th>Last Login</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="systemAccountsBody">
                        <!-- System accounts will be loaded here -->
                    </tbody>
                </table>
            </div>

            <!-- Team Table -->
            <table class="team-table" id="teamTable">
                <thead>
                    <tr>
                        <th style="width: 40px;">No</th>
                        <th>Color</th>
                        <th>Employee</th>
                        <th>Department</th>
                        <th>Role</th>
                        <th>Contract</th>
                        <th>Status</th>
                        <th>Holidays</th>
                        <th>Account Role</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="teamTableBody">
                    <!-- Team members will be loaded here -->
                </tbody>
            </table>
            </div><!-- End Active Section -->

            <!-- Archived Section -->
            <div class="archived-section" id="archivedSection">
                <div class="search-bar">
                    <input type="text" id="archivedSearchInput" placeholder="üîç Search archived employees..." onkeyup="searchArchivedTeam()">
                    <select id="filterArchivedReason" onchange="filterArchivedTeam()">
                        <option value="">All Reasons</option>
                        <option value="resigned">Resigned</option>
                        <option value="fired">Fired</option>
                        <option value="contract_ended">Contract Ended</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div id="archivedTeamContainer">
                    <!-- Archived employees will be loaded here -->
                </div>
            </div><!-- End Archived Section -->

        </div>
    </div>

    <!-- Add/Edit Employee Modal -->
    <div class="modal" id="employeeModal">
        <div class="modal-content" style="width: 950px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" id="employeeModalTitle">Add Employee</div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                    <!-- Left Column -->
                    <div>
                        <h4 style="color: #FFA500; margin-bottom: 15px;">Basic Information</h4>
                        
                        <div class="form-group">
                            <label>Full Name *</label>
                            <input type="text" id="empName" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="empEmail">
                        </div>
                        
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="empPhone">
                        </div>
                        
                        <h4 style="color: #FFA500; margin: 20px 0 15px;">Emergency Contact</h4>
                        
                        <div class="form-group">
                            <label>Contact Name</label>
                            <input type="text" id="emergencyName">
                        </div>
                        
                        <div class="form-group">
                            <label>Contact Phone</label>
                            <input type="tel" id="emergencyPhone">
                        </div>
                        
                        <div class="form-group">
                            <label>Relation</label>
                            <input type="text" id="emergencyRelation" placeholder="e.g. Wife, Parent">
                        </div>
                    </div>
                    
                    <!-- Middle Column -->
                    <div>
                        <h4 style="color: #FFA500; margin-bottom: 15px;">Employment Details</h4>
                        
                        <div class="form-group">
                            <label>Employee Number</label>
                            <input type="text" id="empNumber" placeholder="EMP001">
                        </div>
                        
                        <div class="form-group">
                            <label>Department *</label>
                           

                                <select id="empDepartment">
    <option value="production">Production</option>
    <option value="spray">Spray</option>
    <option value="installation">Installation</option>
    <option value="drivers">Drivers</option>
    <option value="management">Management</option>
    <option value="admin">Admin</option>
    <!-- NIE dodawaj warehouse - nie chcesz tego -->
</select>

                                
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Job Type *</label>
                            <select id="empJobType">
                                <option value="">Select...</option>
                                <option value="joiner">Joiner (Stolarz)</option>
                                <option value="sprayer">Sprayer (Lakiernik)</option>
                                <option value="prep">Prep / Spray Junior</option>
                                <option value="labour">Labour (Helper)</option>
                                <option value="office">Office</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Role/Position</label>
                            <input type="text" id="empRole" placeholder="e.g. Senior Carpenter">
                        </div>
                        
                        <div class="form-group">
                            <label>Contract Type</label>
                            <select id="empContract">
                              
                                <option value="contract">Contract</option>
                                <option value="b2b">B2B</option>
                                <option value="apprentice">Apprentice</option>
                            </select>
                        </div>
                        
                        <h4 style="color: #FFA500; margin: 20px 0 15px;">Salary & Dates</h4>
                        
                        <div class="form-group">
                            <label>Salary Type</label>
                            <select id="salaryType">
                                <option value="hourly">Hourly</option>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                                <option value="yearly">Yearly</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Rate (¬£)</label>
                            <input type="number" id="salaryRate" step="0.01" placeholder="25.00">
                        </div>
                        
                        <div class="form-group">
                            <label>Start Date</label>
                            <input type="date" id="empStartDate">
                        </div>
                        
                        <div class="form-group">
                            <label>Holiday Allowance (days/year)</label>
                            <input type="number" id="empHolidayAllowance" value="28" min="0" max="50" placeholder="28">
                        </div>
                        
                        <div class="form-group">
                            <label>Gantt Color</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="color" id="empColor" value="#FFA500">
                                <input type="text" id="empColorHex" value="#FFA500" readonly style="flex: 1;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Column - Sensitive Info -->
                    <div>
                        <h4 style="color: #ef4444; margin-bottom: 15px;">üîí Sensitive Information</h4>
                        
                        <div class="form-group">
                            <label>NIN (National Insurance Number)</label>
                            <input type="text" id="empNIN" placeholder="e.g. AB123456C">
                        </div>
                        
                        <div class="form-group">
                            <label>UTR (Unique Taxpayer Reference)</label>
                            <input type="text" id="empUTR" placeholder="10-digit number">
                        </div>
                        
                        <h4 style="color: #ef4444; margin: 20px 0 15px;">üè• Medical Information</h4>
                        <p style="font-size: 11px; color: #888; margin-bottom: 10px;">Optional - for emergency purposes only</p>
                        
                        <div class="form-group">
                            <label>Blood Type</label>
                            <select id="empBloodType">
                                <option value="">Not specified</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Allergies</label>
                            <input type="text" id="empAllergies" placeholder="e.g. Peanuts, Penicillin">
                        </div>
                        
                        <div class="form-group">
                            <label>Medical Conditions</label>
                            <textarea id="empMedicalNotes" rows="2" placeholder="Any medical conditions..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Special Care Notes</label>
                            <textarea id="empSpecialCare" rows="2" placeholder="Special requirements..."></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label>Notes</label>
                    <textarea id="empNotes" rows="3" placeholder="Any additional information..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn" onclick="closeModal('employeeModal')">Cancel</button>
                <button class="modal-btn primary" onclick="saveEmployee()">Save Employee</button>
            </div>
        </div>
    </div>

    <!-- Wages Modal -->
    <div class="modal" id="wagesModal">
        <div class="modal-content" style="width: 900px;">
            <div class="modal-header">Wages Management</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Add Wage</label>
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 10px; align-items: end;">
                        <div>
                            <small style="color: #888;">Employee</small>
                            <select id="wageEmployee" style="width: 100%;">
                                <option value="">Select Employee...</option>
                            </select>
                        </div>
                        <div>
                            <small style="color: #888;">Period Type</small>
                            <select id="wagePeriodType" onchange="updateWagePeriodFields()" style="width: 100%;">
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                        <div>
                            <small style="color: #888;">Week/Month</small>
                            <select id="wagePeriod" style="width: 100%;">
                            </select>
                        </div>
                        <div>
                            <small style="color: #888;">Gross Amount ¬£</small>
                            <input type="number" id="wageAmount" placeholder="0.00" step="0.01" style="width: 100%;">
                        </div>
                        <button class="modal-btn primary" onclick="addWage()">Add</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Recent Wages</label>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table class="team-table">
                            <thead>
                                <tr>
                                    <th>Employee</th>
                                    <th>Period</th>
                                    <th>Dates</th>
                                    <th>Gross Amount</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="wagesTableBody">
                                <!-- Wages will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn" onclick="exportWagesCSV()">Export CSV</button>
                <button class="modal-btn primary" onclick="closeModal('wagesModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Holidays Modal -->
    <div class="modal" id="holidaysModal">
        <div class="modal-content" style="width: 700px;">
            <div class="modal-header">Holiday Management</div>
            <div class="modal-body">
                <div class="stats-cards" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 20px;">
                    <div class="stat-card">
                        <div class="stat-number" id="totalHolidayDays">0</div>
                        <div class="stat-label">Total Days</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="usedHolidayDays">0</div>
                        <div class="stat-label">Used Days</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="remainingHolidayDays">0</div>
                        <div class="stat-label">Remaining</div>
                    </div>
                </div>
                
                <div style="max-height: 400px; overflow-y: auto;">
                    <table class="team-table">
                        <thead>
                            <tr>
                                <th>Employee</th>
                                <th>Allowance</th>
                                <th>Used</th>
                                <th>Remaining</th>
                                <th>Progress</th>
                            </tr>
                        </thead>
                        <tbody id="holidaysTableBody">
                            <!-- Holiday data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn primary" onclick="closeModal('holidaysModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Detail Panel -->
    <div class="detail-panel" id="detailPanel">
        <div class="detail-header">
            <h2 id="detailName">Employee Details</h2>
            <button class="action-btn" onclick="closeDetailPanel()">‚úï</button>
        </div>
        <div class="detail-body" id="detailBody">
            <!-- Details will be loaded here -->
        </div>
    </div>

    <!-- Scripts -->
   <script src="js/modals.js"></script>
   <script src="js/team-management.js"></script>


    <script>
        // Initialize
        window.addEventListener('DOMContentLoaded', async () => {
            await loadTeam();
            await loadSystemAccounts();
        });

        // Color picker sync
        document.getElementById('empColor').addEventListener('change', (e) => {
            document.getElementById('empColorHex').value = e.target.value;
        });
    </script>
    
    <!-- Password Confirmation Modal (uniwersalny) -->
    <div class="modal" id="passwordConfirmModal" style="z-index: 10000;">
        <div class="modal-content" style="width: 400px;">
            <div class="modal-header" style="background: #ef4444;">
                <span id="passwordConfirmTitle">üîê Confirm with Password</span>
                <span class="close" onclick="closePasswordConfirmModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p id="passwordConfirmMessage" style="margin-bottom: 15px; color: #ccc;">Please enter your password to confirm this action.</p>
                
                <div class="form-group">
                    <label>Your Password</label>
                    <input type="password" id="confirmPassword" placeholder="Enter your password..." autocomplete="current-password">
                </div>
                
                <p id="passwordConfirmError" style="color: #ef4444; font-size: 12px; display: none; margin-top: 10px;"></p>
            </div>
            <div class="modal-footer">
                <button class="modal-btn" onclick="closePasswordConfirmModal()">Cancel</button>
                <button class="modal-btn" onclick="executePasswordConfirm()" style="background: #ef4444;">Confirm</button>
            </div>
        </div>
    </div>
</body>
</html>