<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skylon Joinery - Stock Management</title>
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
    <script>
        const SUPABASE_URL = 'https://iszkquzpoktokmkjmuuq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlzemtxdXpwb2t0b2tta2ptdXVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0Mzg3NTksImV4cCI6MjA2ODAxNDc1OX0.hijtNZIitJkc3BIQsYUkUTi3_l8OlCGSiJZdM9G3ywA';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        console.log('Supabase ready:', supabaseClient);
    </script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="app-title">Skylon Joinery - Stock Management</div>
            <div class="navigation-links">
                <a href="index.html" class="nav-link nav-link-production">üè≠ Production</a>
                <a href="pipeline.html" class="nav-link nav-link-pipeline">üìã Pipeline</a>
                <a href="archive.html" class="nav-link nav-link-archive">üì¶ Archive</a>
                <a href="accounting.html" class="nav-link nav-link-accounting">üí∞ Accounting</a>
                <a href="team.html" class="nav-link nav-link-team">üßë‚Äçü§ù‚Äçüßë Team Management</a>
                <a href="clients.html" class="nav-link nav-link-clients">üë§ Clients</a>
                <a href="stock.html" class="nav-link nav-link-stock">üì¶ Stock</a>
                <a href="suppliers.html" class="nav-link nav-link-stock">üöö Suppliers</a>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <button class="toolbar-btn primary" onclick="openAddStockModal()">+ Add Stock Item</button>
            <button class="toolbar-btn success" onclick="openStockInModal()">üì• Stock IN</button>
            <button class="toolbar-btn danger" onclick="openStockOutModal()">üì§ Stock OUT</button>
            <button class="toolbar-btn" onclick="refreshStock()">üîÑ Refresh</button>
            
            <div style="margin-left: auto; display: flex; gap: 10px; align-items: center;">
                <select id="categoryFilter" onchange="filterStock()" style="padding: 8px; background: #3e3e42; border: 1px solid #555; color: #e8e2d5; border-radius: 3px;">
                    <option value="">All Categories</option>
                    <option value="timber">Timber</option>
                    <option value="hardware">Hardware</option>
                    <option value="sheet">Sheet Materials</option>
                    <option value="glass">Glass</option>
                    <option value="paint">Paint/Finish</option>
                    <option value="windows">Windows</option>
                        <option value="doors">Doors</option>
                        <option value="consumables">Consumables</option>
                        <option value="other">Other</option>
                </select>
                <button class="toolbar-btn" onclick="openManageCategoriesModal()" style="font-size: 12px;">‚öôÔ∏è Manage Categories</button>
            </div>
        </div>

        <!-- Stats -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 20px;">
            <div style="background: #2d2d30; padding: 15px; border-radius: 5px;">
                <div style="font-size: 24px; font-weight: bold; color: #4CAF50;" id="totalItems">0</div>
                <div style="font-size: 12px; color: #999;">Total Items</div>
            </div>
            <div style="background: #2d2d30; padding: 15px; border-radius: 5px;">
                <div style="font-size: 24px; font-weight: bold; color: #ff9800;" id="lowStockCount">0</div>
                <div style="font-size: 12px; color: #999;">Low Stock</div>
            </div>
            <div style="background: #2d2d30; padding: 15px; border-radius: 5px;">
                <div style="font-size: 24px; font-weight: bold; color: #2196F3;" id="totalValue">¬£0</div>
                <div style="font-size: 12px; color: #999;">Total Value</div>
            </div>
            <div style="background: #2d2d30; padding: 15px; border-radius: 5px;">
                <div style="font-size: 24px; font-weight: bold; color: #9C27B0;" id="recentTransactions">0</div>
                <div style="font-size: 12px; color: #999;">Today's Transactions</div>
            </div>
        </div>

        <!-- Stock Table -->
        <div style="padding: 0 20px 20px;">
            <div id="stockContainer"></div>
        </div>
    </div>

    <!-- Add Stock Item Modal -->
    <div class="modal" id="addStockModal">
        <div class="modal-content">
            <div class="modal-header">Add Stock Item</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Item Name *</label>
                    <input type="text" id="stockName" placeholder="e.g. Red Grandis Engineering Wood">
                </div>
                
                <div class="form-group">
                    <label>Size/Dimensions</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="stockSize" placeholder="e.g. 63x120, 2070x2800" style="flex: 1;">
                        <select id="stockSizeUnit" style="width: 120px;">
                            <option value="mm">mm</option>
                            <option value="mm√ómm">mm√ómm</option>
                            <option value="inch">inch</option>
                            <option value="inch√óinch">inch√óinch</option>
                            <option value="m">m</option>
                            <option value="kg">kg</option>
                            <option value="ml">ml</option>
                            <option value="litres">litres</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Thickness</label>
                    <input type="text" id="stockThickness" placeholder="e.g. 18mm, 25mm">
                </div>
                
                <div class="form-group">
                    <label>Color</label>
                    <input type="text" id="stockColor" placeholder="e.g. White, Chrome, Black">
                </div>
                
                <div class="form-group">
                    <label>Category *</label>
                    <select id="stockCategory" onchange="updateSubcategoryOptions()">
                        <option value="timber">Timber</option>
                        <option value="hardware">Hardware</option>
                        <option value="sheet">Sheet Materials</option>
                        <option value="glass">Glass</option>
                        <option value="paint">Paint/Finish</option>
                        <option value="windows">Windows</option>
                        <option value="doors">Doors</option>
                        <option value="consumables">Consumables</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Subcategory</label>
                    <select id="stockSubcategory">
                        <option value="">-- Select subcategory --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Unit *</label>
                    <select id="stockUnit">
                        <option value="pcs">Pieces (pcs)</option>
                        <option value="m">Meters (m)</option>
                        <option value="m2">Square Meters (m¬≤)</option>
                        <option value="m3">Cubic Meters (m¬≥)</option>
                        <option value="sheets">Sheets</option>
                        <option value="litres">Litres</option>
                        <option value="kg">Kilograms (kg)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Minimum Stock Level *</label>
                    <input type="number" id="stockMinQty" value="0" step="0.01">
                </div>
                
                <div class="form-group">
                    <label>Cost per Unit (¬£)</label>
                    <input type="number" id="stockCost" value="0" step="0.01">
                </div>
                
                <div class="form-group">
                    <label>Supplier</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="stockSupplier" style="flex: 1;">
                            <option value="">-- Select supplier --</option>
                        </select>
                        <button type="button" onclick="openAddSupplierModal()" class="toolbar-btn primary" style="padding: 8px 12px; white-space: nowrap;">+ Add Supplier</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Material Link (URL)</label>
                    <input type="url" id="stockLink" placeholder="https://supplier.com/product">
                </div>
                
                <div class="form-group">
                    <label>Material Image</label>
                    <input type="file" id="stockImage" accept="image/*" onchange="previewStockImage(this)">
                    <div id="stockImagePreview" style="margin-top: 10px;"></div>
                </div>
                
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="stockNotes" rows="2" placeholder="Additional notes..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn" onclick="closeModal('addStockModal')">Cancel</button>
                <button class="modal-btn primary" onclick="saveStockItem()">Save</button>
            </div>
        </div>
    </div>

    <!-- Stock IN Modal -->
    <div class="modal" id="stockInModal">
        <div class="modal-content">
            <div class="modal-header">Stock IN - Add Delivery</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Filter by Category</label>
                    <select id="stockInCategoryFilter" onchange="filterStockInItems()">
                        <option value="">All Categories</option>
                        <option value="timber">Timber</option>
                        <option value="hardware">Hardware</option>
                        <option value="sheet">Sheet Materials</option>
                        <option value="glass">Glass</option>
                        <option value="paint">Paint/Finish</option>
                        <option value="windows">Windows</option>
                        <option value="doors">Doors</option>
                        <option value="consumables">Consumables</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Select Item *</label>
                    <select id="stockInItem" onchange="onStockInItemChange()">
                        <option value="">Select stock item...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Supplier *</label>
                    <select id="stockInSupplier">
                        <option value="">-- Select supplier --</option>
                    </select>
                    <div style="font-size: 11px; color: #999; margin-top: 3px;">Who is delivering this material?</div>
                </div>
                
                <div class="form-group">
                    <label>Received by (Worker) *</label>
                    <select id="stockInWorker">
                        <option value="">-- Select worker --</option>
                    </select>
                    <div style="font-size: 11px; color: #999; margin-top: 3px;">Who received this delivery?</div>
                </div>
                
                <div class="form-group">
                    <label>Quantity *</label>
                    <input type="number" id="stockInQty" step="0.01" min="0" oninput="calculateStockInCost()">
                </div>
                
                <div class="form-group">
                    <label>Cost per Unit (¬£) *</label>
                    <input type="number" id="stockInCostPerUnit" step="0.01" min="0" oninput="calculateStockInCost()">
                    <div style="font-size: 11px; color: #999; margin-top: 3px;">Default from item, can be changed for this delivery</div>
                </div>
                
                <div class="form-group">
                    <label>Total Cost (¬£)</label>
                    <input type="number" id="stockInCost" step="0.01" min="0" readonly style="background: #252526; font-weight: bold;">
                    <div style="font-size: 11px; color: #999; margin-top: 3px;">Auto-calculated: Quantity √ó Cost per Unit</div>
                </div>
                
                <div class="form-group">
                    <label>Invoice Number</label>
                    <input type="text" id="stockInInvoice" placeholder="INV-12345">
                </div>
                
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="stockInNotes" rows="2" placeholder="Delivery notes..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn" onclick="closeModal('stockInModal')">Cancel</button>
                <button class="modal-btn success" onclick="saveStockIn()">Add to Stock</button>
            </div>
        </div>
    </div>

    <!-- Stock OUT Modal -->
    <div class="modal" id="stockOutModal">
        <div class="modal-content">
            <div class="modal-header">Stock OUT - Use for Project</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Select Item *</label>
                    <select id="stockOutItem">
                        <option value="">Select stock item...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Quantity *</label>
                    <input type="number" id="stockOutQty" step="0.01" min="0">
                    <div id="stockOutAvailable" style="font-size: 11px; color: #999; margin-top: 5px;"></div>
                </div>
                
                <div class="form-group">
                    <label>Project Number *</label>
                    <select id="stockOutProject">
                        <option value="">-- Select project --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Worker Taking Out *</label>
                    <select id="stockOutWorker">
                        <option value="">-- Select worker --</option>
                    </select>
                    <div style="font-size: 11px; color: #999; margin-top: 3px;">Who is taking this material?</div>
                </div>
                
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="stockOutNotes" rows="2" placeholder="Usage notes..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn" onclick="closeModal('stockOutModal')">Cancel</button>
                <button class="modal-btn danger" onclick="saveStockOut()">Use from Stock</button>
            </div>
        </div>
    </div>

    <!-- Add Supplier Modal -->
    <div class="modal" id="addSupplierModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">Add Supplier</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Supplier Name *</label>
                    <input type="text" id="supplierName" placeholder="Company name">
                </div>
                
                <div class="form-group">
                    <label>Contact Person</label>
                    <input type="text" id="supplierContact" placeholder="Contact name">
                </div>
                
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="supplierEmail" placeholder="email@supplier.com">
                </div>
                
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" id="supplierPhone" placeholder="+44 ...">
                </div>
                
                <div class="form-group">
                    <label>Website</label>
                    <input type="url" id="supplierWebsite" placeholder="https://supplier.com">
                </div>
                
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="supplierNotes" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn" onclick="closeModal('addSupplierModal')">Cancel</button>
                <button class="modal-btn primary" onclick="saveSupplier()">Save Supplier</button>
            </div>
        </div>
    </div>

    <!-- Edit Stock Item Modal -->
    <div class="modal" id="editStockModal">
        <div class="modal-content">
            <div class="modal-header">Edit Stock Item</div>
            <div class="modal-body">
                <input type="hidden" id="editStockId">
                
                <div class="form-group">
                    <label>Item Name *</label>
                    <input type="text" id="editStockName">
                </div>
                
                <div class="form-group">
                    <label>Size/Dimensions</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="editStockSize" style="flex: 1;">
                        <select id="editStockSizeUnit" style="width: 120px;">
                            <option value="mm">mm</option>
                            <option value="mm√ómm">mm√ómm</option>
                            <option value="inch">inch</option>
                            <option value="inch√óinch">inch√óinch</option>
                            <option value="m">m</option>
                            <option value="kg">kg</option>
                            <option value="ml">ml</option>
                            <option value="litres">litres</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Thickness</label>
                    <input type="text" id="editStockThickness" placeholder="e.g. 18mm, 25mm">
                </div>
                
                <div class="form-group">
                    <label>Color</label>
                    <input type="text" id="editStockColor" placeholder="e.g. White, Chrome, Black">
                </div>
                
                <div class="form-group">
                    <label>Category *</label>
                    <select id="editStockCategory" onchange="updateEditSubcategoryOptions()">
                        <option value="timber">Timber</option>
                        <option value="hardware">Hardware</option>
                        <option value="sheet">Sheet Materials</option>
                        <option value="glass">Glass</option>
                        <option value="paint">Paint/Finish</option>
                        <option value="windows">Windows</option>
                        <option value="doors">Doors</option>
                        <option value="consumables">Consumables</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Subcategory</label>
                    <select id="editStockSubcategory">
                        <option value="">-- Select subcategory --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Unit *</label>
                    <select id="editStockUnit">
                        <option value="pcs">Pieces (pcs)</option>
                        <option value="m">Meters (m)</option>
                        <option value="m2">Square Meters (m¬≤)</option>
                        <option value="m3">Cubic Meters (m¬≥)</option>
                        <option value="sheets">Sheets</option>
                        <option value="litres">Litres</option>
                        <option value="kg">Kilograms (kg)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Minimum Stock Level *</label>
                    <input type="number" id="editStockMinQty" step="0.01">
                </div>
                
                <div class="form-group">
                    <label>Cost per Unit (¬£)</label>
                    <input type="number" id="editStockCost" step="0.01">
                </div>
                
                <div class="form-group">
                    <label>Supplier</label>
                    <select id="editStockSupplier">
                        <option value="">-- Select supplier --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Material Link (URL)</label>
                    <input type="url" id="editStockLink">
                </div>
                
                <div class="form-group">
                    <label>Material Image</label>
                    <input type="file" id="editStockImage" accept="image/*" onchange="previewEditStockImage(this)">
                    <div id="editStockImagePreview" style="margin-top: 10px;"></div>
                    <input type="hidden" id="editStockImageUrl">
                </div>
                
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="editStockNotes" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn danger" onclick="deleteStockItem()" style="margin-right: auto;">Delete</button>
                <button class="modal-btn" onclick="closeModal('editStockModal')">Cancel</button>
                <button class="modal-btn primary" onclick="updateStockItem()">Update</button>
            </div>
        </div>
    </div>

    <!-- Manage Categories Modal -->
    <div class="modal" id="manageCategoriesModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>Manage Categories & Subcategories</h2>
                <button class="close-btn" onclick="closeModal('manageCategoriesModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                    <button class="modal-btn primary" onclick="openAddCategoryModal()">+ Add Category</button>
                    <button class="modal-btn" onclick="openAddSubcategoryModal()">+ Add Subcategory</button>
                </div>
                
                <div id="categoriesList" style="max-height: 400px; overflow-y: auto;">
                    <!-- Categories bƒôdƒÖ tutaj ≈Çadowane dynamicznie -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn" onclick="closeModal('manageCategoriesModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div class="modal" id="addCategoryModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>Add Category</h2>
                <button class="close-btn" onclick="closeModal('addCategoryModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Category Name *</label>
                    <input type="text" id="newCategoryName" placeholder="e.g. Timber, Hardware...">
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn" onclick="closeModal('addCategoryModal')">Cancel</button>
                <button class="modal-btn primary" onclick="saveNewCategory()">Add Category</button>
            </div>
        </div>
    </div>

    <!-- Add Subcategory Modal -->
    <div class="modal" id="addSubcategoryModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>Add Subcategory</h2>
                <button class="close-btn" onclick="closeModal('addSubcategoryModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Parent Category *</label>
                    <select id="subcategoryParent">
                        <option value="">-- Select category --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Subcategory Name *</label>
                    <input type="text" id="newSubcategoryName" placeholder="e.g. Hinges, Locks...">
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn" onclick="closeModal('addSubcategoryModal')">Cancel</button>
                <button class="modal-btn primary" onclick="saveNewSubcategory()">Add Subcategory</button>
            </div>
        </div>
    </div>

    <!-- Modals will go here -->
    <script src="js/data.js"></script>
    <script src="js/stock-app.js"></script>
</body>
</html>